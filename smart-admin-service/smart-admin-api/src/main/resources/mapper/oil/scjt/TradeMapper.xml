<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="net.lab1024.smartadmin.module.oil.scjt.dao.TradeDao">

    <resultMap id="CarInOutNumVO" type="net.lab1024.smartadmin.module.oil.scjt.domain.vo.CarInOutNumVO"></resultMap>
    <resultMap id="CarInOutNumExcelVO" type="net.lab1024.smartadmin.module.oil.scjt.domain.vo.CarInOutNumExcelVO"></resultMap>

    <resultMap id="TradeVO" type="net.lab1024.smartadmin.module.oil.scjt.domain.vo.TradeVO"></resultMap>

    <resultMap id="MatchRatioVO" type="net.lab1024.smartadmin.module.oil.scjt.domain.vo.MatchRatioVO"></resultMap>

    <resultMap id="MatchTrackVO" type="net.lab1024.smartadmin.module.oil.scjt.domain.vo.MatchTrackVO"></resultMap>

    <resultMap id="CarTraceVO" type="net.lab1024.smartadmin.module.oil.scjt.domain.vo.CarTraceVO"></resultMap>

    <resultMap id="CarTrafficFlowVO" type="net.lab1024.smartadmin.module.oil.scjt.domain.vo.CarTrafficFlowVO"></resultMap>
    <resultMap id="CarGrowthAnalyseBO" type="net.lab1024.smartadmin.module.oil.scjt.domain.bo.CarGrowthAnalyseBO"></resultMap>

    <!-- 交易明细/车牌矫正 -->
    <select id="queryByPage" resultMap="TradeVO">
        SELECT
            *
        FROM
            fullingdb.bus_tradelog
        <where>

            <if test="queryDTO.startTime != null">
                AND endtime <![CDATA[ >= ]]> #{queryDTO.startTime}
            </if>
            <if test="queryDTO.endTime != null">
                AND endtime <![CDATA[ <= ]]> #{queryDTO.endTime}
            </if>
            <if test="queryDTO.stationAreaName != null and queryDTO.stationAreaName != ''">
                AND station_area_name LIKE CONCAT('%', #{queryDTO.stationAreaName}, '%')
            </if>
            <if test="queryDTO.stationAreaNames != null">
                AND station_area_name in (
                <foreach collection="queryDTO.stationAreaNames" item="item" index="index" separator=",">
                    #{item}
                </foreach>
                )
            </if>
            <if test="queryDTO.stationExpName != null and queryDTO.stationExpName != ''">
                AND station_exp_name LIKE CONCAT('%', #{queryDTO.stationExpName}, '%')
            </if>
            <if test="queryDTO.stationExpNames != null">
                AND station_exp_name in (
                <foreach collection="queryDTO.stationExpNames" item="item" index="index" separator=",">
                    #{item}
                </foreach>
                )
            </if>
            <if test="queryDTO.stationExpServiceArea != null and queryDTO.stationExpServiceArea != ''">
                AND station_exp_service_area LIKE CONCAT('%', #{queryDTO.stationExpServiceArea}, '%')
            </if>
            <if test="queryDTO.stationExpServiceAreas != null">
                AND station_exp_service_area in (
                <foreach collection="queryDTO.stationExpServiceAreas" item="item" index="index" separator=",">
                    #{item}
                </foreach>
                )
            </if>
            <if test="queryDTO.stationCode != null and queryDTO.stationCode != ''">
                AND station_code LIKE CONCAT('%', #{queryDTO.stationCode}, '%')
            </if>
            <if test="queryDTO.stationCodes != null">
                AND station_code in (
                <foreach collection="queryDTO.stationCodes" item="item" index="index" separator=",">
                    #{item}
                </foreach>
                )
            </if>
            <if test="queryDTO.stationName != null and queryDTO.stationName != ''">
                AND station_name LIKE CONCAT('%', #{queryDTO.stationName}, '%')
            </if>
            <if test="queryDTO.stationNames != null">
                AND station_name in (
                <foreach collection="queryDTO.stationNames" item="item" index="index" separator=",">
                    #{item}
                </foreach>
                )
            </if>
            <if test="queryDTO.oilCode != null and queryDTO.oilCode != ''">
                AND oilcode LIKE CONCAT('%', #{queryDTO.oilCode}, '%')
            </if>
            <if test="queryDTO.oilCodes != null">
                AND oilcode in (
                <foreach collection="queryDTO.oilCodes" item="item" index="index" separator=",">
                    #{item}
                </foreach>
                )
            </if>
            <if test="queryDTO.nozzleNo != null and queryDTO.nozzleNo != ''">
                AND nozzleno = #{queryDTO.nozzleNo}
            </if>
            <if test="queryDTO.billNo != null and queryDTO.billNo != ''">
                AND billNo = #{queryDTO.billNo}
            </if>
            <if test="queryDTO.carNumber != null and queryDTO.carNumber != ''">
                AND carnumber LIKE CONCAT('%', #{queryDTO.carNumber}, '%')
            </if>
        </where>
    </select>

    <!-- 匹配率 -->
    <select id="queryMatchRatio" resultMap="MatchRatioVO">
        SELECT
            COUNT( distinct endtime) total_deal,
            SUM(case when length(carnumber) > 1 then 1 else 0 end) is_match
        FROM
        fullingdb.bus_tradelog
        <where>
            <if test="queryDTO.startTime != null">
                AND endtime <![CDATA[ >= ]]> #{queryDTO.startTime}
            </if>
            <if test="queryDTO.endTime != null">
                AND endtime <![CDATA[ <= ]]> #{queryDTO.endTime}
            </if>
            <if test="queryDTO.stationAreaName != null and queryDTO.stationAreaName != ''">
                AND station_area_name LIKE CONCAT('%', #{queryDTO.stationAreaName}, '%')
            </if>
            <if test="queryDTO.stationExpName != null and queryDTO.stationExpName != ''">
                AND station_exp_name LIKE CONCAT('%', #{queryDTO.stationExpName}, '%')
            </if>
            <if test="queryDTO.stationExpServiceArea != null and queryDTO.stationExpServiceArea != ''">
                AND station_exp_service_area LIKE CONCAT('%', #{queryDTO.stationExpServiceArea}, '%')
            </if>
            <if test="queryDTO.stationCode != null and queryDTO.stationCode != ''">
                AND station_code LIKE CONCAT('%', #{queryDTO.stationCode}, '%')
            </if>
            <if test="queryDTO.stationName != null and queryDTO.stationName != ''">
                AND station_name LIKE CONCAT('%', #{queryDTO.stationName}, '%')
            </if>
            <if test="queryDTO.oilCode != null and queryDTO.oilCode != ''">
                AND oilcode LIKE CONCAT('%', #{queryDTO.oilCode}, '%')
            </if>
            <if test="queryDTO.nozzleNo != null and queryDTO.nozzleNo != ''">
                AND nozzleno = #{queryDTO.nozzleNo}
            </if>
            <if test="queryDTO.billNo != null and queryDTO.billNo != ''">
                AND billNo = #{queryDTO.billNo}
            </if>
            <if test="queryDTO.carNumber != null and queryDTO.carNumber != ''">
                AND carnumber LIKE CONCAT('%', #{queryDTO.carNumber}, '%')
            </if>
        </where>
    </select>

    <!-- 进出站频次 -->
<!--
    <select id="getCarInOutNum_Bak" resultMap="CarInOutNumVO">
        SELECT
        carnumber, count( key1 ) frequency
        FROM
        (
        SELECT
        DISTINCT carnumber, endtime, key1
        FROM
        (
        SELECT
        carnumber, date( date_add( endtime, INTERVAL 8 HOUR ) ) endtime, CONCAT( carnumber, ' ', date( date_add( endtime, INTERVAL 8 HOUR ) ) ) key1
        FROM
        fullingdb.bus_tradelog
        WHERE
        <if test="queryDTO.startTime != null">
            endtime <![CDATA[ >= ]]> #{queryDTO.startTime} AND
        </if>
        <if test="queryDTO.endTime != null">
            endtime <![CDATA[ <= ]]> #{queryDTO.endTime} AND
        </if>
        <if test="queryDTO.stationCode != null and queryDTO.stationCode != ''">
            station_code LIKE CONCAT('%', #{queryDTO.stationCode}, '%') AND
        </if>
        <if test="queryDTO.stationName != null and queryDTO.stationName != ''">
            station_name LIKE CONCAT('%', #{queryDTO.stationName}, '%') AND
        </if>
        <if test="queryDTO.carNumber != null and queryDTO.carNumber != ''">
            carnumber LIKE CONCAT('%', #{queryDTO.carNumber}, '%') AND
        </if>
        ASCII( carnumber ) > 127
        ) a
        ) b
        GROUP BY carnumber
        <if test="queryDTO.minFrequency != null and queryDTO.minFrequency != '' and queryDTO.maxFrequency != null and queryDTO.maxFrequency != ''">
            HAVING COUNT( key1 ) <![CDATA[ >= ]]> #{queryDTO.minFrequency} AND COUNT( key1 ) <![CDATA[ <= ]]> #{queryDTO.maxFrequency}
        </if>

    </select>
-->
    <select id="getCarInOutNum" resultMap="CarInOutNumVO">
        SELECT
            carnumber, date(endtime) endtime, CONCAT(carnumber, ' ', date(endtime)) frequency
        FROM
            fullingdb.bus_tradelog
        WHERE
            <if test="queryDTO.startTime != null">
                endtime <![CDATA[ >= ]]> #{queryDTO.startTime} AND
            </if>
            <if test="queryDTO.endTime != null">
                endtime <![CDATA[ <= ]]> #{queryDTO.endTime} AND
            </if>
            <if test="queryDTO.stationCode != null and queryDTO.stationCode != ''">
                station_code LIKE CONCAT('%', #{queryDTO.stationCode}, '%') AND
            </if>
            <if test="queryDTO.stationName != null and queryDTO.stationName != ''">
                station_name LIKE CONCAT('%', #{queryDTO.stationName}, '%') AND
            </if>
            <if test="queryDTO.carNumber != null and queryDTO.carNumber != ''">
                carnumber LIKE CONCAT('%', #{queryDTO.carNumber}, '%') AND
            </if>
            ASCII( carnumber ) > 127
    </select>
    <select id="getCarInOutNumCount" resultType="java.lang.Long">
        SELECT
            count(carnumber)
        FROM
        fullingdb.bus_tradelog
        WHERE
        <if test="queryDTO.startTime != null">
            endtime <![CDATA[ >= ]]> #{queryDTO.startTime} AND
        </if>
        <if test="queryDTO.endTime != null">
            endtime <![CDATA[ <= ]]> #{queryDTO.endTime} AND
        </if>
        <if test="queryDTO.stationCode != null and queryDTO.stationCode != ''">
            station_code LIKE CONCAT('%', #{queryDTO.stationCode}, '%') AND
        </if>
        <if test="queryDTO.stationName != null and queryDTO.stationName != ''">
            station_name LIKE CONCAT('%', #{queryDTO.stationName}, '%') AND
        </if>
        <if test="queryDTO.carNumber != null and queryDTO.carNumber != ''">
            carnumber LIKE CONCAT('%', #{queryDTO.carNumber}, '%') AND
        </if>
        ASCII( carnumber ) > 127
    </select>


    <!-- 车辆识别情况跟踪/匹配率变化 -->
    <select id="queryMatchTrackByPage" resultMap="MatchTrackVO">
        SELECT
            station_area_name, station_exp_name, station_exp_service_area,station_code, station_name,
            count(distinct endtime) total_deal,
            SUM(case when length(carnumber) > 1 then 1 else 0 end) is_match
        FROM
            fullingdb.bus_tradelog
        <where>
            <if test="queryDTO.startTime != null">
                AND endtime <![CDATA[ >= ]]> #{queryDTO.startTime}
            </if>
            <if test="queryDTO.endTime != null">
                AND endtime <![CDATA[ <= ]]> #{queryDTO.endTime}
            </if>
            <if test="queryDTO.stationAreaName != null and queryDTO.stationAreaName != ''">
                AND station_area_name LIKE CONCAT('%', #{queryDTO.stationAreaName}, '%')
            </if>
            <if test="queryDTO.stationExpName != null and queryDTO.stationExpName != ''">
                AND station_exp_name LIKE CONCAT('%', #{queryDTO.stationExpName}, '%')
            </if>
            <if test="queryDTO.stationExpServiceArea != null and queryDTO.stationExpServiceArea != ''">
                AND station_exp_service_area LIKE CONCAT('%', #{queryDTO.stationExpServiceArea}, '%')
            </if>
            <if test="queryDTO.stationCode != null and queryDTO.stationCode != ''">
                AND station_code LIKE CONCAT('%', #{queryDTO.stationCode}, '%')
            </if>
            <if test="queryDTO.stationName != null and queryDTO.stationName != ''">
                AND station_name LIKE CONCAT('%', #{queryDTO.stationName}, '%')
            </if>
            <if test="queryDTO.carNumber != null and queryDTO.carNumber != ''">
                AND carnumber LIKE CONCAT('%', #{queryDTO.carNumber}, '%')
            </if>
        </where>
        GROUP BY
        station_area_name, station_exp_name, station_exp_service_area, station_code, station_name
    </select>
    <select id="queryMatchTrackByPageCount" resultType="java.lang.Long">
        SELECT
            COUNT(DISTINCT CONCAT(station_code, station_name))
        FROM
            fullingdb.bus_tradelog
        <where>
            <if test="queryDTO.startTime != null">
                AND endtime <![CDATA[ >= ]]> #{queryDTO.startTime}
            </if>
            <if test="queryDTO.endTime != null">
                AND endtime <![CDATA[ <= ]]> #{queryDTO.endTime}
            </if>
            <if test="queryDTO.stationAreaName != null and queryDTO.stationAreaName != ''">
                AND station_area_name LIKE CONCAT('%', #{queryDTO.stationAreaName}, '%')
            </if>
            <if test="queryDTO.stationExpName != null and queryDTO.stationExpName != ''">
                AND station_exp_name LIKE CONCAT('%', #{queryDTO.stationExpName}, '%')
            </if>
            <if test="queryDTO.stationExpServiceArea != null and queryDTO.stationExpServiceArea != ''">
                AND station_exp_service_area LIKE CONCAT('%', #{queryDTO.stationExpServiceArea}, '%')
            </if>
            <if test="queryDTO.stationCode != null and queryDTO.stationCode != ''">
                AND station_code LIKE CONCAT('%', #{queryDTO.stationCode}, '%')
            </if>
            <if test="queryDTO.stationName != null and queryDTO.stationName != ''">
                AND station_name LIKE CONCAT('%', #{queryDTO.stationName}, '%')
            </if>
            <if test="queryDTO.carNumber != null and queryDTO.carNumber != ''">
                AND carnumber LIKE CONCAT('%', #{queryDTO.carNumber}, '%')
            </if>
        </where>
    </select>

    <!-- 油枪车辆识别情况跟踪 -->
    <select id="queryNozzleNoMatchTrackByPage" resultMap="MatchTrackVO">
        SELECT
            station_code, station_name, nozzleno,
            count(distinct endtime) total_deal,
            sum(case when length(carnumber) > 1 then 1 else 0 end) is_match
        FROM
        fullingdb.bus_tradelog
        <where>
            <if test="queryDTO.startTime != null">
                AND endtime <![CDATA[ >= ]]> #{queryDTO.startTime}
            </if>
            <if test="queryDTO.endTime != null">
                AND endtime <![CDATA[ <= ]]> #{queryDTO.endTime}
            </if>
            <if test="queryDTO.stationAreaName != null and queryDTO.stationAreaName != ''">
                AND station_area_name LIKE CONCAT('%', #{queryDTO.stationAreaName}, '%')
            </if>
            <if test="queryDTO.stationExpName != null and queryDTO.stationExpName != ''">
                AND station_exp_name LIKE CONCAT('%', #{queryDTO.stationExpName}, '%')
            </if>
            <if test="queryDTO.stationExpServiceArea != null and queryDTO.stationExpServiceArea != ''">
                AND station_exp_service_area LIKE CONCAT('%', #{queryDTO.stationExpServiceArea}, '%')
            </if>
            <if test="queryDTO.stationCode != null and queryDTO.stationCode != ''">
                AND station_code LIKE CONCAT('%', #{queryDTO.stationCode}, '%')
            </if>
            <if test="queryDTO.stationName != null and queryDTO.stationName != ''">
                AND station_name LIKE CONCAT('%', #{queryDTO.stationName}, '%')
            </if>
            <if test="queryDTO.carNumber != null and queryDTO.carNumber != ''">
                AND carnumber LIKE CONCAT('%', #{queryDTO.carNumber}, '%')
            </if>
        </where>
        GROUP BY station_code, station_name, nozzleno
        ORDER BY station_code, station_name, nozzleno
    </select>
    <select id="queryNozzleNoMatchTrackByPageCount" resultType="java.lang.Long">
        SELECT
            COUNT(DISTINCT CONCAT(station_code, station_name, nozzleno))
        FROM
            fullingdb.bus_tradelog
        <where>
            <if test="queryDTO.startTime != null">
                AND endtime <![CDATA[ >= ]]> #{queryDTO.startTime}
            </if>
            <if test="queryDTO.endTime != null">
                AND endtime <![CDATA[ <= ]]> #{queryDTO.endTime}
            </if>
            <if test="queryDTO.stationAreaName != null and queryDTO.stationAreaName != ''">
                AND station_area_name LIKE CONCAT('%', #{queryDTO.stationAreaName}, '%')
            </if>
            <if test="queryDTO.stationExpName != null and queryDTO.stationExpName != ''">
                AND station_exp_name LIKE CONCAT('%', #{queryDTO.stationExpName}, '%')
            </if>
            <if test="queryDTO.stationExpServiceArea != null and queryDTO.stationExpServiceArea != ''">
                AND station_exp_service_area LIKE CONCAT('%', #{queryDTO.stationExpServiceArea}, '%')
            </if>
            <if test="queryDTO.stationCode != null and queryDTO.stationCode != ''">
                AND station_code LIKE CONCAT('%', #{queryDTO.stationCode}, '%')
            </if>
            <if test="queryDTO.stationName != null and queryDTO.stationName != ''">
                AND station_name LIKE CONCAT('%', #{queryDTO.stationName}, '%')
            </if>
            <if test="queryDTO.carNumber != null and queryDTO.carNumber != ''">
                AND carnumber LIKE CONCAT('%', #{queryDTO.carNumber}, '%')
            </if>
        </where>
    </select>

    <!-- 车牌跟踪 -->
<!--
    <select id="queryCarTraceByPage_Bak" resultMap="CarTraceVO">
        SELECT
            left(carnumber,1) province,
            mid(carnumber,2,1) city,
            carnumber,
            date_add(t.endtime,interval 8 hour) endtime,
            date_add(t.starttime,interval 8 hour) starttime,
            t.endtime,
            o.paytime,
            o.billno,
            o.nozzleno,
            o.realamount,
            o.volume,
            CONCAT(t.oilcode,t.oilclass) oilcode,
            t.oilclass,
            t.station_name,
            t.station_code,
            station_area_name,
            station_exp_name,
            station_exp_service_area
        from
            (
            select paytime,billno,realamount,volume,station_code,nozzleno,startread,endread,max(update_time)
            from fullingdb.bus_orderlog
            <where>
                <if test="queryDTO.startTime != null">
                    AND date_add(paytime,interval 8 hour) <![CDATA[ >= ]]> #{queryDTO.startTime}
                </if>
                <if test="queryDTO.endTime != null">
                    AND date_add(paytime,interval 8 hour) <![CDATA[ <= ]]> #{queryDTO.endTime}
                </if>
            </where>
            group by paytime,billno,realamount,volume,station_code,nozzleno,startread,endread
            ) o
        left join
            (
            select station_code,nozzleno,startread,endread,carnumber,endtime,starttime,oilclass,oilcode,station_name,station_area_name,station_exp_name,station_exp_service_area
            from fullingdb.bus_tradelog
            where
            <if test="queryDTO.startTime != null">
                date_add(endtime,interval 8 hour) <![CDATA[ >= ]]> #{queryDTO.startTime} AND
            </if>
            <if test="queryDTO.endTime != null">
                date_add(endtime,interval 8 hour) <![CDATA[ <= ]]> #{queryDTO.endTime} AND
            </if>
                ASCII(carnumber) <![CDATA[>]]> 127
            ) t
        on o.station_code=t.station_code
            and o.nozzleno=t.nozzleno
            and o.startread=t.startread
            and o.endread=t.endread
        WHERE
        <if test="queryDTO.startTime != null">
            date_add(t.endtime,interval 8 hour) <![CDATA[ >= ]]> #{queryDTO.startTime} AND
        </if>
        <if test="queryDTO.endTime != null">
            date_add(t.endtime,interval 8 hour) <![CDATA[ <= ]]> #{queryDTO.endTime} AND
        </if>
        <if test="queryDTO.stationAreaName != null and queryDTO.stationAreaName != ''">
            t.station_area_name LIKE CONCAT('%', #{queryDTO.stationAreaName}, '%') AND
        </if>
        <if test="queryDTO.stationExpName != null and queryDTO.stationExpName != ''">
            t.station_exp_name LIKE CONCAT('%', #{queryDTO.stationExpName}, '%') AND
        </if>
        <if test="queryDTO.stationExpServiceArea != null and queryDTO.stationExpServiceArea != ''">
            t.station_exp_service_area LIKE CONCAT('%', #{queryDTO.stationExpServiceArea}, '%') AND
        </if>
        <if test="queryDTO.stationCode != null and queryDTO.stationCode != ''">
            t.station_code LIKE CONCAT('%', #{queryDTO.stationCode}, '%') AND
        </if>
        <if test="queryDTO.stationName != null and queryDTO.stationName != ''">
            t.station_name LIKE CONCAT('%', #{queryDTO.stationName}, '%') AND
        </if>
        <if test="queryDTO.oilCode != null and queryDTO.oilCode != ''">
            t.oilcode LIKE CONCAT('%', #{queryDTO.oilCode}, '%') AND
        </if>
        <if test="queryDTO.carNumber != null and queryDTO.carNumber != ''">
            t.carnumber LIKE CONCAT('%', #{queryDTO.carNumber}, '%') AND
        </if>
            length(t.carnumber) <![CDATA[>]]> 0
    </select>
-->
    <select id="queryCarTraceByPage" resultMap="CarTraceVO">
        SELECT
            t.station_code,t.nozzleno,t.startread,t.endread,t.carnumber,t.endtime,t.starttime,
            t.oilclass,t.oilcode,t.station_name,t.station_area_name,t.station_exp_name,t.station_exp_service_area,
            o.paytime,o.billno,o.realamount,o.volume,o.station_code,o.nozzleno,o.startread,o.endread,max(o.update_time) update_time
        FROM
            fullingdb.bus_tradelog t
        RIGHT JOIN
            fullingdb.bus_orderlog o
        ON o.station_code = t.station_code AND o.nozzleno = t.nozzleno AND o.startread = t.startread AND o.endread = t.endread
        <where>
            <if test="queryDTO.startTime != null">
                t.endtime <![CDATA[ >= ]]> #{queryDTO.startTime} AND
            </if>
            <if test="queryDTO.endTime != null">
                t.endtime <![CDATA[ <= ]]> #{queryDTO.endTime} AND
            </if>
            <if test="queryDTO.startTime != null">
                o.paytime <![CDATA[ >= ]]> #{queryDTO.startTime} AND
            </if>
            <if test="queryDTO.endTime != null">
                o.paytime <![CDATA[ <= ]]> #{queryDTO.endTime} AND
            </if>
            <if test="queryDTO.stationAreaName != null and queryDTO.stationAreaName != ''">
                t.station_area_name LIKE CONCAT('%', #{queryDTO.stationAreaName}, '%') AND
            </if>
            <if test="queryDTO.stationExpName != null and queryDTO.stationExpName != ''">
                t.station_exp_name LIKE CONCAT('%', #{queryDTO.stationExpName}, '%') AND
            </if>
            <if test="queryDTO.stationExpServiceArea != null and queryDTO.stationExpServiceArea != ''">
                t.station_exp_service_area LIKE CONCAT('%', #{queryDTO.stationExpServiceArea}, '%') AND
            </if>
            <if test="queryDTO.stationCode != null and queryDTO.stationCode != ''">
                t.station_code LIKE CONCAT('%', #{queryDTO.stationCode}, '%') AND
            </if>
            <if test="queryDTO.stationName != null and queryDTO.stationName != ''">
                t.station_name LIKE CONCAT('%', #{queryDTO.stationName}, '%') AND
            </if>
            <if test="queryDTO.oilCode != null and queryDTO.oilCode != ''">
                t.oilcode LIKE CONCAT('%', #{queryDTO.oilCode}, '%') AND
            </if>
            <if test="queryDTO.carNumber != null and queryDTO.carNumber != ''">
                t.carnumber LIKE CONCAT('%', #{queryDTO.carNumber}, '%') AND
            </if>
            length(t.carnumber) <![CDATA[>]]> 0
        </where>
    </select>
    <select id="queryCarTraceByPageCount" resultType="java.lang.Long">
        SELECT
            count(1)
        FROM
        fullingdb.bus_tradelog t
        RIGHT JOIN
        fullingdb.bus_orderlog o
        ON o.station_code = t.station_code AND o.nozzleno = t.nozzleno AND o.startread = t.startread AND o.endread = t.endread
        <where>
            <if test="queryDTO.startTime != null">
                t.endtime <![CDATA[ >= ]]> #{queryDTO.startTime} AND
            </if>
            <if test="queryDTO.endTime != null">
                t.endtime <![CDATA[ <= ]]> #{queryDTO.endTime} AND
            </if>
            <if test="queryDTO.startTime != null">
                o.paytime <![CDATA[ >= ]]> #{queryDTO.startTime} AND
            </if>
            <if test="queryDTO.endTime != null">
                o.paytime <![CDATA[ <= ]]> #{queryDTO.endTime} AND
            </if>
            <if test="queryDTO.stationAreaName != null and queryDTO.stationAreaName != ''">
                t.station_area_name LIKE CONCAT('%', #{queryDTO.stationAreaName}, '%') AND
            </if>
            <if test="queryDTO.stationExpName != null and queryDTO.stationExpName != ''">
                t.station_exp_name LIKE CONCAT('%', #{queryDTO.stationExpName}, '%') AND
            </if>
            <if test="queryDTO.stationExpServiceArea != null and queryDTO.stationExpServiceArea != ''">
                t.station_exp_service_area LIKE CONCAT('%', #{queryDTO.stationExpServiceArea}, '%') AND
            </if>
            <if test="queryDTO.stationCode != null and queryDTO.stationCode != ''">
                t.station_code LIKE CONCAT('%', #{queryDTO.stationCode}, '%') AND
            </if>
            <if test="queryDTO.stationName != null and queryDTO.stationName != ''">
                t.station_name LIKE CONCAT('%', #{queryDTO.stationName}, '%') AND
            </if>
            <if test="queryDTO.oilCode != null and queryDTO.oilCode != ''">
                t.oilcode LIKE CONCAT('%', #{queryDTO.oilCode}, '%') AND
            </if>
            <if test="queryDTO.carNumber != null and queryDTO.carNumber != ''">
                t.carnumber LIKE CONCAT('%', #{queryDTO.carNumber}, '%') AND
            </if>
            length(t.carnumber) <![CDATA[>]]> 0
        </where>
    </select>

    <!-- 车流走势 -->
    <select id="queryCarTrafficFlowByPage" resultMap="CarTrafficFlowVO">
        SELECT
            <if test="queryDTO.chartRadioType == 1">
                cast(endtime as date) endtime,
            </if>
            <if test="queryDTO.chartRadioType == 0">
                left(carnumber,1) province,
            </if>
            station_area_name,
            station_exp_name,
            station_exp_service_area,
            station_name,
            station_code,
            count(distinct endtime) total_deal,
            SUM(case when length(carnumber) > 1 then 1 else 0 end) is_match,
            sum(volume) volume
        FROM fullingdb.bus_tradelog
        <where>
            <if test="queryDTO.startTime != null">
                AND endtime <![CDATA[ >= ]]> #{queryDTO.startTime}
            </if>
            <if test="queryDTO.endTime != null">
                AND endtime <![CDATA[ <= ]]> #{queryDTO.endTime}
            </if>
            <if test="queryDTO.stationAreaName != null and queryDTO.stationAreaName != ''">
                AND station_area_name LIKE CONCAT('%', #{queryDTO.stationAreaName}, '%')
            </if>
            <if test="queryDTO.stationExpName != null and queryDTO.stationExpName != ''">
                AND station_exp_name LIKE CONCAT('%', #{queryDTO.stationExpName}, '%')
            </if>
            <if test="queryDTO.stationExpServiceArea != null and queryDTO.stationExpServiceArea != ''">
                AND station_exp_service_area LIKE CONCAT('%', #{queryDTO.stationExpServiceArea}, '%')
            </if>
            <if test="queryDTO.stationCode != null and queryDTO.stationCode != ''">
                AND station_code LIKE CONCAT('%', #{queryDTO.stationCode}, '%')
            </if>
            <if test="queryDTO.stationName != null and queryDTO.stationName != ''">
                AND station_name LIKE CONCAT('%', #{queryDTO.stationName}, '%')
            </if>
            <if test="queryDTO.carNumber != null and queryDTO.carNumber != ''">
                AND carnumber LIKE CONCAT('%', #{queryDTO.carNumber}, '%')
            </if>
            <if test="queryDTO.oilClass != null and queryDTO.oilClass != ''">
                AND oilclass LIKE CONCAT('%', #{queryDTO.oilClass}, '%')
            </if>
            <if test="queryDTO.oilCode != null and queryDTO.oilCode != ''">
                AND oilcode LIKE CONCAT('%', #{queryDTO.oilCode}, '%')
            </if>
        </where>
        GROUP BY
            station_area_name, station_exp_name, station_exp_service_area, station_name, station_code
            <if test="queryDTO.chartRadioType == 1">
                ,enddate
            </if>
            <if test="queryDTO.chartRadioType == 0">
                ,left(carnumber,1)
            </if>
        ORDER BY endtime
    </select>
    <select id="queryCarTrafficFlowByPageCount" resultType="java.lang.Long">
        SELECT
            <if test="queryDTO.chartRadioType == 1">
                COUNT(DISTINCT CONCAT(station_area_name,station_exp_name,station_exp_service_area,station_name,station_code,cast(endtime as date)))
            </if>
            <if test="queryDTO.chartRadioType == 0">
                COUNT(DISTINCT CONCAT(station_area_name,station_exp_name,station_exp_service_area,station_name,station_code,left(carnumber,1)))
            </if>
            <if test="queryDTO.chartRadioType != 1 and queryDTO.chartRadioType != 0">
                COUNT(DISTINCT CONCAT(station_area_name,station_exp_name,station_exp_service_area,station_name,station_code))
            </if>
        FROM fullingdb.bus_tradelog
        <where>
            <if test="queryDTO.startTime != null">
                AND endtime <![CDATA[ >= ]]> #{queryDTO.startTime}
            </if>
            <if test="queryDTO.endTime != null">
                AND endtime <![CDATA[ <= ]]> #{queryDTO.endTime}
            </if>
            <if test="queryDTO.stationAreaName != null and queryDTO.stationAreaName != ''">
                AND station_area_name LIKE CONCAT('%', #{queryDTO.stationAreaName}, '%')
            </if>
            <if test="queryDTO.stationExpName != null and queryDTO.stationExpName != ''">
                AND station_exp_name LIKE CONCAT('%', #{queryDTO.stationExpName}, '%')
            </if>
            <if test="queryDTO.stationExpServiceArea != null and queryDTO.stationExpServiceArea != ''">
                AND station_exp_service_area LIKE CONCAT('%', #{queryDTO.stationExpServiceArea}, '%')
            </if>
            <if test="queryDTO.stationCode != null and queryDTO.stationCode != ''">
                AND station_code LIKE CONCAT('%', #{queryDTO.stationCode}, '%')
            </if>
            <if test="queryDTO.stationName != null and queryDTO.stationName != ''">
                AND station_name LIKE CONCAT('%', #{queryDTO.stationName}, '%')
            </if>
            <if test="queryDTO.carNumber != null and queryDTO.carNumber != ''">
                AND carnumber LIKE CONCAT('%', #{queryDTO.carNumber}, '%')
            </if>
            <if test="queryDTO.oilClass != null and queryDTO.oilClass != ''">
                AND oilclass LIKE CONCAT('%', #{queryDTO.oilClass}, '%')
            </if>
            <if test="queryDTO.oilCode != null and queryDTO.oilCode != ''">
                AND oilcode LIKE CONCAT('%', #{queryDTO.oilCode}, '%')
            </if>
        </where>
    </select>

    <select id="queryCarTrafficFlowChart" resultMap="CarTrafficFlowVO">
        SELECT
        <if test="queryDTO.chartRadioType == 1 and queryDTO.timeRadioType == 1">
            DATE_FORMAT(endtime, '%Y') endtime,
        </if>
        <if test="queryDTO.chartRadioType == 1 and queryDTO.timeRadioType == 2">
            DATE_FORMAT(endtime, '%Y-%m') endtime,
        </if>
        <if test="queryDTO.chartRadioType == 2 and queryDTO.carAttributionType == 1">
            case when length(carnumber) > 1 then left(carnumber,1) else '-' end carnumber,
        </if>
        <if test="queryDTO.chartRadioType == 2 and queryDTO.carAttributionType == 2">
            case when length(carnumber) > 1 then CONCAT(left(carnumber,1), mid(carnumber,2,1)) else '-' end carnumber,
        </if>
        <if test="queryDTO.chartRadioType == 2 and queryDTO.carAttributionType == 3">
            case when length(carnumber) > 1 then carnumber else '-' end carnumber,
        </if>
        <if test="queryDTO.oilClass != null and queryDTO.oilClass != ''">
            oilclass,
        </if>
        <if test="queryDTO.oilCode != null and queryDTO.oilCode != ''">
            oilcode,
        </if>
        station_area_name,
        station_exp_name,
        station_exp_service_area,
        station_name,
        station_code,
        count(distinct endtime) total_deal,
        SUM(case when length(carnumber) > 1 then 1 else 0 end) is_match,
        sum(volume) volume
        FROM fullingdb.bus_tradelog
        <where>
            <if test="queryDTO.startTime != null">
                AND endtime <![CDATA[ >= ]]> #{queryDTO.startTime}
            </if>
            <if test="queryDTO.endTime != null">
                AND endtime <![CDATA[ <= ]]> #{queryDTO.endTime}
            </if>
            <if test="queryDTO.stationAreaName != null and queryDTO.stationAreaName != ''">
                AND station_area_name LIKE CONCAT('%', #{queryDTO.stationAreaName}, '%')
            </if>
            <if test="queryDTO.stationExpName != null and queryDTO.stationExpName != ''">
                AND station_exp_name LIKE CONCAT('%', #{queryDTO.stationExpName}, '%')
            </if>
            <if test="queryDTO.stationExpServiceArea != null and queryDTO.stationExpServiceArea != ''">
                AND station_exp_service_area LIKE CONCAT('%', #{queryDTO.stationExpServiceArea}, '%')
            </if>
            <if test="queryDTO.stationCode != null and queryDTO.stationCode != ''">
                AND station_code LIKE CONCAT('%', #{queryDTO.stationCode}, '%')
            </if>
            <if test="queryDTO.stationName != null and queryDTO.stationName != ''">
                AND station_name LIKE CONCAT('%', #{queryDTO.stationName}, '%')
            </if>
            <if test="queryDTO.carNumber != null and queryDTO.carNumber != ''">
                AND carnumber LIKE CONCAT('%', #{queryDTO.carNumber}, '%')
            </if>
            <if test="queryDTO.oilClass != null and queryDTO.oilClass != ''">
                AND oilclass LIKE CONCAT('%', #{queryDTO.oilClass}, '%')
            </if>
            <if test="queryDTO.oilCode != null and queryDTO.oilCode != ''">
                AND oilcode LIKE CONCAT('%', #{queryDTO.oilCode}, '%')
            </if>
        </where>
        GROUP BY
            station_area_name, station_exp_name, station_exp_service_area, station_name, station_code
            <if test="queryDTO.oilClass != null and queryDTO.oilClass != ''">
                ,oilclass
            </if>
            <if test="queryDTO.oilCode != null and queryDTO.oilCode != ''">
                ,oilcode
            </if>
            <if test="queryDTO.chartRadioType == 1 and queryDTO.timeRadioType == 1">
                ,DATE_FORMAT(endtime, '%Y')
            </if>
            <if test="queryDTO.chartRadioType == 1 and queryDTO.timeRadioType == 2">
                ,DATE_FORMAT(endtime, '%Y-%m')
            </if>
            <if test="queryDTO.chartRadioType == 2 and queryDTO.carAttributionType == 1">
                ,left(carnumber,1)
            </if>
            <if test="queryDTO.chartRadioType == 2 and queryDTO.carAttributionType == 2">
                ,CONCAT(left(carnumber,1), mid(carnumber,2,1))
            </if>
            <if test="queryDTO.chartRadioType == 2 and queryDTO.carAttributionType == 3">
                ,carnumber
            </if>
        ORDER BY endtime
    </select>

    <select id="queryGrowthAnalyse" resultMap="CarGrowthAnalyseBO">
        SELECT
            enddate endtime, station_area_name,
            <if test="queryDTO.growthAnalyseStationType == 0">
                station_exp_name, station_exp_service_area,
            </if>
            <if test="queryDTO.growthAnalyseStationType == 1">
                station_exp_name, station_exp_service_area, station_name, station_code,
            </if>
            oilclass,
            oilcode,
            count(distinct endtime) total_deal,
            SUM(case when length(carnumber) > 1 then 1 else 0 end) is_match,
            ROUND(sum(volume), 4) volume
        FROM fullingdb.bus_tradelog
        WHERE
            endtime <![CDATA[ >= ]]> #{queryDTO.startTime} AND endtime <![CDATA[ <= ]]> #{queryDTO.endTime}
            <if test="queryDTO.stationAreaName != null and queryDTO.stationAreaName != ''">
                AND station_area_name LIKE CONCAT('%', #{queryDTO.stationAreaName}, '%')
            </if>
            <if test="queryDTO.stationExpName != null and queryDTO.stationExpName != ''">
                AND station_exp_name LIKE CONCAT('%', #{queryDTO.stationExpName}, '%')
            </if>
            <if test="queryDTO.stationExpServiceArea != null and queryDTO.stationExpServiceArea != ''">
                AND station_exp_service_area LIKE CONCAT('%', #{queryDTO.stationExpServiceArea}, '%')
            </if>
            <if test="queryDTO.oilClass != null and queryDTO.oilClass != ''">
                AND oilclass LIKE CONCAT('%', #{queryDTO.oilClass}, '%')
            </if>
            <if test="queryDTO.oilCode != null and queryDTO.oilCode != ''">
                AND oilcode LIKE CONCAT('%', #{queryDTO.oilCode}, '%')
            </if>
            <if test="queryDTO.carNumber != null and queryDTO.carNumber != ''">
                AND carnumber LIKE CONCAT('%', #{queryDTO.carNumber}, '%')
            </if>
        GROUP BY
            enddate, station_area_name,
            <if test="queryDTO.growthAnalyseStationType == 0">
                station_exp_name, station_exp_service_area,
            </if>
            <if test="queryDTO.growthAnalyseStationType == 1">
                station_exp_name, station_exp_service_area, station_name, station_code,
            </if>
            oilclass,oilcode
        ORDER BY endtime

    </select>

    <select id="queryGrowthAnalyseByPage" resultMap="CarGrowthAnalyseBO">
        SELECT
        cast(endtime as date) endtime,
        <if test="queryDTO.growthAnalyseStationType == 0">
            station_area_name, station_exp_name, station_exp_service_area,
        </if>
        <if test="queryDTO.growthAnalyseStationType == 1">
            station_area_name, station_exp_name, station_exp_service_area, station_name, station_code,
        </if>
        oilclass,
        oilcode,
        count(distinct endtime) total_deal,
        SUM(case when length(carnumber) > 1 then 1 else 0 end) is_match,
        ROUND(sum(volume), 4) volume
        FROM fullingdb.bus_tradelog
        WHERE
        (endtime <![CDATA[ >= ]]> #{queryDTO.startTime} AND endtime <![CDATA[ <= ]]> #{queryDTO.endTime})
        <if test="queryDTO.stationAreaName != null and queryDTO.stationAreaName != ''">
            AND station_area_name LIKE CONCAT('%', #{queryDTO.stationAreaName}, '%')
        </if>
        <if test="queryDTO.stationExpName != null and queryDTO.stationExpName != ''">
            AND station_exp_name LIKE CONCAT('%', #{queryDTO.stationExpName}, '%')
        </if>
        <if test="queryDTO.stationExpServiceArea != null and queryDTO.stationExpServiceArea != ''">
            AND station_exp_service_area LIKE CONCAT('%', #{queryDTO.stationExpServiceArea}, '%')
        </if>
        <if test="queryDTO.carNumber != null and queryDTO.carNumber != ''">
            AND carnumber LIKE CONCAT('%', #{queryDTO.carNumber}, '%')
        </if>
        GROUP BY
            cast(endtime as date),
        <if test="queryDTO.growthAnalyseStationType == 0">
            station_area_name, station_exp_name, station_exp_service_area,
        </if>
        <if test="queryDTO.growthAnalyseStationType == 1">
            station_area_name, station_exp_name, station_exp_service_area, station_name, station_code,
        </if>
        oilclass,oilcode
        ORDER BY endtime

    </select>

</mapper>
